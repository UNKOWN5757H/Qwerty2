# bot/short.py

import re
from bot import Bot
from urllib.parse import urlparse
from pyrogram import filters
from pyrogram.errors.pyromod.listener_timeout import ListenerTimeout
from pyrogram.types import (
    InlineKeyboardButton,
    InlineKeyboardMarkup,
    ReplyKeyboardMarkup,
    ReplyKeyboardRemove,
)
from shortzy import Shortzy #type: ignore

from database.database import kingdb
from config import OWNER_ID


async def get_variable(key, default=None):
    return await kingdb.get_variable(key, default)


async def set_variable(key, value):
    await kingdb.set_variable(key, value)

@Bot.on_message(filters.command("short") & filters.user(OWNER_ID) & filters.private)
async def short(client, message):
    """Display shortener settings"""
    a = await get_variable("api", "None")
    c = await get_variable("bypass", "0")
    b = await get_variable("website", "None")
    aba = await get_variable("short", "")
    mode = await get_variable("mode", "I")
    
    if aba and mode == "24":
        d = "ğŸğŸ’ğ‡ âœ…"
        e = "âœ…"
        f = ""
    elif aba and mode == "link":
        d = "ğğ„ğ‘ ğ‹ğˆğğŠ âœ…"
        f = "âœ…"
        e = ""
    elif not aba:
        d = "âŒ"
        e = ""
        f = ""
    else:
        d = ""
        e = ""
        f = ""
        
    g = await get_variable("token_time", 0)

    total_seconds = int(g)
    hours = total_seconds // 3600
    minutes = (total_seconds % 3600) // 60
    seconds = total_seconds % 60

    time_parts = []
    if hours:
        time_parts.append(f"{hours} hour{'s' if hours > 1 else ''}")
    if minutes:
        time_parts.append(f"{minutes} minute{'s' if minutes > 1 else ''}")
    if seconds and not hours:
        time_parts.append(f"{seconds} second{'s' if seconds > 1 else ''}")

    g = " ".join(time_parts) if time_parts else "0 seconds"

    txt = (
        f"<blockquote expandable>â™»ï¸ ğ’ğ‡ğğ‘ğ“ğğ„ğ‘ ğ’ğ„ğ“ğ“ğˆğğ†ğ’ ğŸ’ </blockquote>\n"
        f"<blockquote>ğŸ’¥ ğ’ğ‡ğğ‘ğ“ğğ„ğ‘ ğŒğğƒğ„: {d} </blockquote>\n"
        f"<blockquote>â­ ğ•ğ„ğ‘ğˆğ…ğˆğ‚ğ€ğ“ğˆğğ ğ“ğˆğŒğ„ : {g} </blockquote>\n"
        f"<blockquote expandable>âš ï¸ ğ€ğğˆ : {a}</blockquote>\n"
        f"<blockquote expandable>ğŸŒ ğ–ğ„ğğ’ğˆğ“ğ„ : {b}</blockquote>\n"
        f"<blockquote expandable>ğ‹ğˆğğŠğ’ ğğ˜ğğ€ğ’ğ’ğ„ğƒ : {c}</blockquote>"
    )

    keyboard = InlineKeyboardMarkup(
        [
            [InlineKeyboardButton("ğ‘ğ„ğŒğğ•ğ„ ğ’ğ‡ğğ‘ğ“ğ„ğ‘ âŒ", callback_data="short_rem")],
            [
                InlineKeyboardButton(f"ğŸğŸ’ğ‡ ğŒğğƒğ„ {e}", callback_data="mode_24"),
                InlineKeyboardButton(f"ğğ„ğ‘ ğ‹ğˆğğŠ ğŒğğƒğ„ {f}", callback_data="mode_link"),
            ],
            [
                InlineKeyboardButton("ğ‚ğ‡ğ€ğğ†ğ„ ğ–ğ„ğğ’ğˆğ“ğ„ ", callback_data="short_web"),
                InlineKeyboardButton("ğ‚ğ‡ğ€ğğ†ğ„ ğ€ğğˆ", callback_data="short_api"),
            ],
            [
                InlineKeyboardButton("Ï²â„“Î¿Ñ•Ñ”", callback_data="close"),
            ],
        ]
    )

    await message.reply_photo(
        photo="https://i.ibb.co/5xtpFb2T/f4faad6ca1c1.jpg",
        caption=txt,
        reply_markup=keyboard,
    )


async def short2(client, query):
    """Handle shortener web/api changes"""
    uid = query.from_user.id
    
    # Check if user is owner
    if uid != OWNER_ID:
        await query.answer(
            "âŒ ÏÎ±ÎºÎºÎ±!, Î³Î¿Ï… Î±ÑÑ” Ğ¸Î¿Ï„ Î±â„“â„“Î¿Ï‰Ñ”âˆ‚ Ï„Î¿ Ï…Ñ•Ñ” Ï„Ğ½Ñ” ÏÏ…Ï„Ï„Î¿Ğ¸", show_alert=True
        )
        return
        
    action = query.data.split("_")[1]
    txt = "<blockquote expandable>ğğ‹ğ„ğ€ğ’ğ„ ğ’ğ„ğğƒ ğŒğ„ ğ’ğ‡ğğ‘ğ“ğğ„ğ‘ ğ–ğ„ğğ’ğˆğ“ğ„ </blockquote>"
    tot = "<blockquote expandable>ğğ‹ğ„ğ€ğ’ğ„ ğ’ğ„ğğƒ ğŒğ„ ğ’ğ‡ğğ‘ğ“ğğ„ğ‘ ğ–ğ„ğğ’ğˆğ“ğ„ ğ€ğğˆ</blockquote>"
    
    if action == "web":
        while True:
            b = await client.send_message(
                uid,
                text=txt,
                reply_markup=ReplyKeyboardMarkup(
                    [["âŒ Cancel"]], one_time_keyboard=True, resize_keyboard=True
                ),
            )
            try:
                a = await client.listen(timeout=30, chat_id=uid)
            except ListenerTimeout:
                await client.send_message(
                    chat_id=uid,
                    text="â³ Timeout! Setup cancelled.",
                    reply_markup=ReplyKeyboardRemove(),
                )
                await b.delete()
                break
                
            if a.text.lower() == "âŒ cancel":
                await client.send_message(
                    chat_id=uid,
                    text="âŒ WEBSITE setup cancelled.",
                    reply_markup=ReplyKeyboardRemove(),
                )
                await b.delete()
                break

            try:
                parsed_url = urlparse(a.text)
            except BaseException:
                await client.send_message(
                    chat_id=uid,
                    text="Please send me full website link like https://example.com",
                    reply_markup=ReplyKeyboardRemove(),
                )
                await b.delete()
                continue

            if (
                parsed_url.scheme == "https"
                and parsed_url.netloc
                and not parsed_url.path.strip("/")
            ):
                pass
            else:
                await client.send_message(
                    chat_id=uid,
                    text="Please send me full website link like https://example.com",
                    reply_markup=ReplyKeyboardRemove(),
                )
                await b.delete()
                continue

            await set_variable("website", a.text)
            await client.send_message(
                chat_id=uid, text="âœ… ğ–ğ„ğğ’ğˆğ“ğ„ ğ€ğƒğƒğ„ğƒ ğ’ğ”ğ‚ğ‚ğ„ğ’ğ’ğ…ğ”ğ‹ğ‹ğ˜ "
            )
            await b.delete()
            await short(client, query.message)
            await query.message.delete()
            break
            
    if action == "api":
        while True:
            b = await client.send_message(
                uid,
                text=tot,
                reply_markup=ReplyKeyboardMarkup(
                    [["âŒ Cancel"]], one_time_keyboard=True, resize_keyboard=True
                ),
            )
            try:
                a = await client.listen(timeout=30, chat_id=uid)
            except ListenerTimeout:
                await client.send_message(
                    chat_id=uid,
                    text="â³ Timeout! Setup cancelled.",
                    reply_markup=ReplyKeyboardRemove(),
                )
                await b.delete()
                break
                
            if a.text.lower() == "âŒ cancel":
                await client.send_message(
                    chat_id=uid,
                    text="âŒ API setup cancelled.",
                    reply_markup=ReplyKeyboardRemove(),
                )
                await b.delete()
                break
                
            await set_variable("api", a.text)
            await client.send_message(chat_id=uid, text="âœ… ğ€ğğˆ ğ€ğƒğƒğ„ğƒ ğ’ğ”ğ‚ğ‚ğ„ğ’ğ’ğ…ğ”ğ‹ğ‹ğ˜ ")
            await b.delete()
            await short(client, query.message)
            await query.message.delete()
            break


async def short3(client, query):
    """Remove shortener"""
    uid = query.from_user.id
    
    if uid != OWNER_ID:
        await query.answer(
            "âŒ ÏÎ±ÎºÎºÎ±!, Î³Î¿Ï… Î±ÑÑ” Ğ¸Î¿Ï„ Î±â„“â„“Î¿Ï‰Ñ”âˆ‚ Ï„Î¿ Ï…Ñ•Ñ” Ï„Ğ½Ñ” ÏÏ…Ï„Ï„Î¿Ğ¸", show_alert=True
        )
        return
        
    aba = await get_variable("short", None)
    if aba:
        await set_variable("short", False)
        await set_variable("mode", None)
        await short(client, query.message)
        await query.message.delete()
    else:
        await query.answer(
            "Invalid Input, Shortner is already removed", show_alert=True
        )


async def short4(client, query):
    """Handle shortener mode changes"""
    uid = query.from_user.id
    
    if uid != OWNER_ID:
        await query.answer(
            "âŒ ÏÎ±ÎºÎºÎ±!, Î³Î¿Ï… Î±ÑÑ” Ğ¸Î¿Ï„ Î±â„“â„“Î¿Ï‰Ñ”âˆ‚ Ï„Î¿ Ï…Ñ•Ñ” Ï„Ğ½Ñ” ÏÏ…Ï„Ï„Î¿Ğ¸", show_alert=True
        )
        return

    action = query.data.split("_")[1]

    if action == "link":
        aba = await get_variable("short", None)
        if not aba:
            await set_variable("short", True)
        await set_variable("mode", "link")
        await short(client, query.message)
        await query.message.delete()
        
    elif action == "24":
        while True:
            try:
                b = await query.message.edit(
                    text=(
                        "âš ï¸ ğ’ğğ§ğ ğ’ğ‡ğğ‘ğ“ğğ„ğ‘ ğ•ğ„ğ‘ğˆğ…ğˆğ‚ğ€ğ“ğˆğğ ğ“ğ¢ğ¦ğ ğ…ğ¨ğ«ğ¦ğšğ­ ----->\n"
                        "<blockquote>Xh - êœ°á´Ê€ x Êœá´á´œÊ€êœ±, á´‡x: 1h {á´É´á´‡ Êœá´á´œÊ€},\n"
                        "Xm - êœ°á´Ê€ x á´ÉªÉ´á´œá´›á´‡êœ±, á´‡x: 1m {á´É´á´‡ á´ÉªÉ´á´œá´›á´‡},\n"
                        "Xs - êœ°á´Ê€ x êœ±á´‡á´„á´É´á´…êœ±, á´‡x: 1s {á´É´á´‡ êœ±á´‡á´„á´É´á´…}</blockquote>"
                    ),
                    reply_markup=ReplyKeyboardMarkup(
                        [["âŒ Cancel"]], one_time_keyboard=True, resize_keyboard=True
                    ),
                )
            except BaseException:
                pass

            try:
                a = await client.listen(chat_id=uid, timeout=30)
            except ListenerTimeout:
                await client.send_message(
                    chat_id=uid,
                    text="â³ Timeout! Setup cancelled.",
                    reply_markup=ReplyKeyboardRemove(),
                )
                break

            if a.text.lower() == "âŒ cancel":
                await b.edit(
                    "âŒ Timer setup cancelled.", reply_markup=ReplyKeyboardRemove()
                )
                break

            time_pattern = re.match(r"^(\d+)([hms])$", a.text.lower())

            if time_pattern:
                value, unit = int(time_pattern.group(1)), time_pattern.group(2)

                if unit == "h":
                    ab = f"{value * 3600}"
                elif unit == "m":
                    ab = f"{value * 60}"
                elif unit == "s":
                    ab = str(value)
                    
                await set_variable("token_time", ab)
                await b.delete()
                aba = await get_variable("short", None)
                if not aba:
                    await set_variable("short", True)
                await set_variable("mode", "24")
                await short(client, query.message)
                await query.message.delete()
                break
            else:
                await a.reply_text(
                    "âŒ Invalid format! Try again (e.g., `1h`, `30m`, `45s`)."
                )


async def get_shortlink(link):
    """Generate short link"""
    url = await get_variable("website")
    if url and url.startswith("https://"):
        url = url.replace("https://", "", 1)
    api = await get_variable("api")
    shortzy = Shortzy(api_key=api, base_site=url)
    link = await shortzy.convert(link)
    return link
